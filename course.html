<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Syllabus</title>
	<link rel="stylesheet" type="text/css" href="course.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script type="text/javascript">
		var syllabusList = [];
		var syllabusListErrors = [];

		$(function() {
			showRecords()
		});

		function showRecords() {
			$.ajax({
				url: "showRecords.php",
				type: 'POST',
				dataType: 'JSON',
				success: function(response){
					counter = 0;
					while(counter < response.length){
						syllabusListErrors[counter] = {editMode:false,isTitleValid:true,isDescriptionValid:true,isTagsValid:true};
						counter++;
					}
					syllabusList = response;
					renderCards(response);
				},
				error: function (jqXHR, exception) {
					var msg = '';
					if (jqXHR.status === 0) {
						msg = 'Not Connected.\n Verify Network.';
					} else if (jqXHR.status == 404) {
						msg = 'Requested page not found. [404]';
					} else if (jqXHR.status == 500) {
						msg = 'Internal Server Error [500].';
					} else if (exception === 'parsererror') {
						msg = 'Requested JSON parse failed.';
					} else if (exception === 'timeout') {
						msg = 'Time out error.';
					} else if (exception === 'abort') {
						msg = 'Ajax request aborted.';
					} else {
					msg = 'Uncaught Error.\n' + jqXHR.responseText;
					}
					$('#output').html(msg);
				},
			});
		}

		function addSyllabus() {
			index = syllabusList.length;
			let emptySyllabusItem = {id:index,title:"",description:"",tags:"",status:1};
			let emptySyllabusItemErrors = {editMode:true,isTitleValid:true,isDescriptionValid:true,isTagsValid:true};
			syllabusList.push(emptySyllabusItem);
			syllabusListErrors.push(emptySyllabusItemErrors);
			renderCards();
		}

		function createCard(index, syllabusItem) {
			let card = `<div id="card" class="syllabusCard">
								<div id="cardBody" class="cardBody">
									<div id="anchorDiv">
										<a class="index">Syllabus ${index + 1}</a>
									</div>
									<h2 class="cardTitle">${syllabusItem["title"]}</h2>
									<p class="cardDescription">${syllabusItem["description"]}</p>
									<ul id="nav$" class="actionsNav alignRight">
										<li class="actionsNav-item">
											<a id="editbtn" href="javascript:edit(${syllabusItem['id']})" class="actionsNav-link">Edit</a>
										</li>
										<li class="actionsNav-item">
											<a href="javascript:deleteSyllabus(${syllabusItem['id']})" class="actionsNav-link">Delete</a>
										</li>
									</ul>
								</div>
						</div>`;
			return card;
		}

		function renderCards() {
			let index = 0;
			$("#cardsDiv").html("");
			let counter = 0;
			for (const syllabusItem of syllabusList) {
				syllabusItemError = syllabusListErrors[counter];
				if(syllabusItem["status"] == 1) {
					if (!syllabusItemError["editMode"]) {
						var HTMLTemplate = createCard(index, syllabusItem);
					}
					else {
						var HTMLTemplate = showForm(index, syllabusItem)
					}
					$("#cardsDiv").append(HTMLTemplate);
					index++;
				}
				counter++;

			}
		}

		function showForm(index, syllabusItem) {
			syllabusItemError = syllabusListErrors[index];
			let form = `<div id="form" name="formFields">
								<div class="formIndex">
									<a class="index" id="index">Syllabus ${index + 1}</a>
								</div>
								<label for="syllabusTitle${syllabusItem['id']}" class="textBoxLabel">Title</label>
								<input type="text" name="syllabusTitle${syllabusItem['id']}" id="syllabusTitle${syllabusItem['id']}" class="textBox" value="${syllabusItem["title"]}">`;
								if (!syllabusItemError["isTitleValid"]) {
									form += `<p class="errorMessage">Invalid Title</p>`;
								}
						form += `<label for="syllabusDescription${syllabusItem['id']}" class="textBoxLabel">Description</label>
								<input type="text" name="syllabusDescription${syllabusItem['id']}" id="syllabusDescription${syllabusItem['id']}" class="textBox" value="${syllabusItem["description"]}">`;
								if (!syllabusItemError["isDescriptionValid"]) {
									form += `<p class="errorMessage">Invalid Description</p>`;
								}
						form +=	`<label for="syllabusTags${syllabusItem['id']}" class="textBoxLabel">Tags</label>
								<input type="text" name="syllabusTags${syllabusItem['id']}" id="syllabusTags${syllabusItem['id']}" class="textBox" value="${syllabusItem["tags"]}">`;
								if (!syllabusItemError["isTagsValid"]) {
									form += `<p class="errorMessage">Invalid Tags</p>`;
								}
						form +=	`<button id="savebtn" class="alignRight formBtn" onclick="saveData(${syllabusItem['id']})">Save</button>
								<button class="alignRight formBtn" onclick="cancel(${syllabusItem['id']})">Cancel</button>
						</div>`;
			return form;
		}

		function cancel(index) {
			syllabusItem = syllabusList[index]
			if((syllabusItem["title"] == "") || (syllabusItem["description"] == "") || (syllabusItem  == "")) {
				syllabusList.splice(index, 1);
	                        syllabusListErrors.splice(index, 1);
			}
			else{
				syllabusListErrors[index]["editMode"]= false;
			}
			renderCards();
		}

		function deleteSyllabus(index) {
			$.ajax({
				url: "delete.php",
				type: 'POST',
				data: {id:index},
				dataType: "JSON",
				success: function(response){
					if(response == 1) {
						syllabusList[index]["status"] = 0;
						$("#output").html("Syllabus Deleted Successfully.");
					}else {
						$("#output").html("Syllabus Not Deleted.");
					}
				},
				error: function() {
					$().html("Syllabus not deleted.");
				}
			});
			renderCards();
		}

		function edit(index) {
			syllabusListErrors[index]["editMode"] = true;
			renderCards();
		}

		function saveData(index) {
			let title = $("#syllabusTitle"+index).val();
			let description = $("#syllabusDescription"+index).val();
			let tags = $("#syllabusTags"+index).val();
			let errorData = {editMode:true,isTitleValid:true,isDescriptionValid:true,isTagsValid:true}
			if (title.length <= 0) {
				errorData.isTitleValid = false;
				errorData.editMode = true;
			}
			if (description.length <= 0) {
				errorData.isDescriptionValid = false;
				errorData.editMode = true;
			}
			if (tags.length <= 0) {
				errorData.isTagsValid = false;
				errorData.editMode = true;
			}
			if (errorData.isTitleValid && errorData.isDescriptionValid && errorData.isTagsValid) {
				errorData.editMode = false;
				formData = {id:index,title:title,description:description,tags:tags,status:1};
				$.ajax({
					url: "insertUpdate.php",
					type: 'POST',
					data: formData,
					dataType: "JSON",
					success: function(response){
						if(response == 1){
							syllabusList[index] = formData;
							syllabusListErrors[index] = errorData;
							renderCards(syllabusList);
							$("#output").html("Syllabus Added/Updated Successfully.");
						}
						else {
							$("#output").html("Syllabus Not Added/Updated.");
						}
					},
					error: function(jqXHR, exception) {
						msg = 'Uncaught Error.\n' + jqXHR.responseText;
					}
				});
			}
			renderCards();
		}
	</script>
</head>
<body>
	<button class="addSyllabus alignRight" id="addSyllabus" onclick="addSyllabus()">Add Syllabus</button>
	<p id="output"></p>
	<div style="border: 1px solid #fff;" class="container cardContainer" id="cardsDiv"></div>
</body>
</html>
