<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Syllabus</title>
	<link rel="stylesheet" type="text/css" href="course.css">
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.3/css/all.css" integrity="sha384-SZXxX4whJ79/gErwcOYf+zWLeJdY/qpuqC4cAa9rOGUstPomtqpuNWT9wdPEn2fk" crossorigin="anonymous">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script type="text/javascript">
		var syllabusList = [];
		var syllabusListErrors = [];
		isEditing = 0;

		$(function() {
			showRecords();
			getUserName();
		});

		function getUserName() {
			$.ajax({
				url: "getUserName.php",
				type: "GET",
				success: function(response) {
					response = JSON.parse(response);
					$(".dropbtn").html("Hi, " + response["userName"] + ' <i class="fas fa-caret-down"></i>');
				}
			});
		}

		function showRecords() {
			$.ajax({
				url: "showRecords.php",
				type: 'GET',
				dataType: 'JSON',
				success: function(response){
					let counter = 0;
					while(counter < response.length){
						syllabusListErrors[counter] = {editMode:false,isTitleValid:true,isDescriptionValid:true,isTagsValid:true};
						counter++;
					}
					syllabusList = response;
					renderCards();
				},
				error: function (jqXHR, exception) {
					window.location.replace("login.php");
					var message = '';
					if (jqXHR.status === 0) {
						message = 'Not Connected.\n Verify Network.';
					} else if (jqXHR.status == 404) {
						message = 'Requested page not found. [404]';
					} else if (jqXHR.status == 500) {
						message = 'Internal Server Error [500].';
					} else if (exception === 'parsererror') {
						message = 'Requested JSON parse failed.';
					} else if (exception === 'timeout') {
						message = 'Time out error.';
					} else if (exception === 'abort') {
						message = 'Ajax request aborted.';
					} else {
						message = 'Uncaught Error.\n' + jqXHR.responseText;
					}
					$('#output').html(message);
				},
			});
		}

		function addSyllabus() {
			index = syllabusList.length;
			let emptySyllabusItem = {id:index,title:"",description:"",tags:"",status:1};
			let emptySyllabusItemErrors = {editMode:true,isTitleValid:true,isDescriptionValid:true,isTagsValid:true};
			syllabusList.push(emptySyllabusItem);
			syllabusListErrors.push(emptySyllabusItemErrors);
			isEditing = 0;
			renderCards();
		}

		function createCard(index, syllabusItem) {
			let card = `<div id="card" class="syllabusCard">
								<div id="cardBody" class="cardBody">
									<div id="anchorDiv">
										<a class="index">Syllabus ${index + 1}</a>
									</div>
									<h2 class="cardTitle">${syllabusItem["title"]}</h2>
									<p class="cardDescription">${syllabusItem["description"]}</p>
									<ul id="nav$" class="actionsNav alignRight">
										<li class="actionsNav-item">
											<a id="editbtn" href="javascript:edit(${index})" class="actionsNav-link">Edit</a>
										</li>
										<li class="actionsNav-item">
											<a href="javascript:deleteSyllabus(${index})" class="actionsNav-link">Delete</a>
										</li>
									</ul>
								</div>
						</div>`;
			return card;
		}

		function renderCards() {
			let index = 0;
			$("#cardsDiv").html("");
			let counter = 0;
			for (const syllabusItem of syllabusList) {
				syllabusItemError = syllabusListErrors[index];
				if (!syllabusItemError["editMode"]) {
					var HTMLTemplate = createCard(index, syllabusItem);
				}
				else {
					var HTMLTemplate = showForm(index, syllabusItem)
				}
				$("#cardsDiv").append(HTMLTemplate);
				index++;
			}
		}

		function showForm(index, syllabusItem) {
			syllabusItemError = syllabusListErrors[index];
			let form = `<div id="form" name="formFields" style="margin-top: 70px;">
								<div class="formIndex">
									<a class="index" id="index">Syllabus ${index + 1}</a>
								</div>
								<label for="syllabusTitle${index}" class="textBoxLabel">Title</label>
								<input type="text" name="syllabusTitle${index}" id="syllabusTitle${index}" class="textBox" value="${syllabusItem["title"]}">`;
								if (!syllabusItemError["isTitleValid"]) {
									form += `<p class="errorMessage">Invalid Title</p>`;
								}
						form += `<label for="syllabusDescription${index}" class="textBoxLabel">Description</label>
								<input type="text" name="syllabusDescription${index}" id="syllabusDescription${index}" class="textBox" value="${syllabusItem["description"]}">`;
								if (!syllabusItemError["isDescriptionValid"]) {
									form += `<p class="errorMessage">Invalid Description</p>`;
								}
						form +=	`<label for="syllabusTags${index}" class="textBoxLabel">Tags</label>
								<input type="text" name="syllabusTags${index}" id="syllabusTags${index}" class="textBox" value="${syllabusItem["tags"]}">`;
								if (!syllabusItemError["isTagsValid"]) {
									form += `<p class="errorMessage">Invalid Tags</p>`;
								}
						form +=	`<button id="savebtn" class="alignRight formBtn" onclick="saveData(${index})">Save</button>
								<button class="alignRight formBtn" onclick="cancel(${index})">Cancel</button>
						</div>`;
			return form;
		}

		function cancel(index) {
			syllabusItem = syllabusList[index];
			if((syllabusItem["title"] == "") || (syllabusItem["description"] == "") || (syllabusItem["tags"]  == "")) {
				syllabusList.splice(index, 1);
				syllabusListErrors.splice(index, 1);
			}
			else{
				syllabusListErrors[index]["editMode"]= false;
			}
			renderCards();
		}

		function deleteSyllabus(index) {
			syllabusItem = syllabusList[index];
			formData = {id:syllabusItem['id']};
			$.ajax({
				url: "delete.php",
				type: 'DELETE',
				data: JSON.stringify(formData),
				dataType: "JSON",
				success: function(response){
					syllabusList.splice(index,1);
					renderCards();
				},
			});
		}

		function edit(index) {
			syllabusListErrors[index]["editMode"] = true;
			isEditing = 1;
			renderCards();
		}

		function saveData(index) {
			syllabusItem = syllabusList[index];
			let title = $("#syllabusTitle" + index).val();
			let description = $("#syllabusDescription" + index).val();
			let tags = $("#syllabusTags" + index).val();
			let errorData = {editMode:true,isTitleValid:true,isDescriptionValid:true,isTagsValid:true}
			if (title.length <= 0) {
				errorData.isTitleValid = false;
				errorData.editMode = true;
			}
			if (description.length <= 0) {
				errorData.isDescriptionValid = false;
				errorData.editMode = true;
			}
			if (tags.length <= 0) {
				errorData.isTagsValid = false;
				errorData.editMode = true;
			}

			if (errorData.isTitleValid && errorData.isDescriptionValid && errorData.isTagsValid) {
				errorData.editMode = false;
				if (isEditing == 0) {
					formData = {title:title,description:description,tags:tags};
					url = "insert.php";
				}
				else {
					id = syllabusItem["id"];
					formData = {id:id,title:title,description:description,tags:tags};
					url = "update.php";
					isEditing = 0;	
				}
				$.ajax({
					url: url,
					type: 'POST',
					data: JSON.stringify(formData),
					dataType: "JSON",
					contentType: "application/json",
					success: function(response){
							syllabusList[index] = response;
							syllabusListErrors[index ] = errorData;
							renderCards();
					},
					error: function(jqXHR, exception) {
						msg = 'Uncaught Error.\n' + jqXHR.responseText;
					}
				});
			}
		}
	</script>
</head>
<body>
	<div class="dropdown alignRight logout-btn">
		<a class="dropbtn" href="login.php">Login</a>
		<div class="dropdown-content">
			<a href="logout.php">Logout</a>
		</div>
	</div>
	<button class="addSyllabus" id="addSyllabus" onclick="addSyllabus()">Add Syllabus</button>
	<p id="output"></p>
	<div class="container cardContainer" id="cardsDiv"></div>
</body>
</html>
